<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>现实版躲猫猫</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <!-- 高德地图API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=你的高德地图Key"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .game-phase {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        .form-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 500px;
            backdrop-filter: blur(10px);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }
        
        button {
            background: #ff5722;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        button:hover {
            background: #e64a19;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        button:disabled {
            background: #777;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .players-list {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
        }
        
        .player {
            padding: 10px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player.ready {
            border-left: 4px solid #4CAF50;
        }
        
        .player.cat {
            background: rgba(255, 87, 34, 0.3);
        }
        
        .player.mouse {
            background: rgba(76, 175, 80, 0.3);
        }
        
        .player.caught {
            opacity: 0.6;
            text-decoration: line-through;
        }
        
        .player.requesting-catch {
            background: rgba(255, 193, 7, 0.3);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { background: rgba(255, 193, 7, 0.3); }
            50% { background: rgba(255, 193, 7, 0.6); }
            100% { background: rgba(255, 193, 7, 0.3); }
        }
        
        .game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #gameMap {
            width: 100%;
            height: 500px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .info-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            flex: 1;
            margin: 0 10px;
            text-align: center;
        }
        
        .status-message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }
        
        .status-hiding {
            background: rgba(255, 193, 7, 0.3);
        }
        
        .status-seeking {
            background: rgba(244, 67, 54, 0.3);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .controls button {
            flex: 1;
        }
        
        .caught-btn {
            background: #f44336;
        }
        
        .host-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .host-controls button {
            flex: 1;
        }
        
        .player-controls {
            margin-top: 15px;
        }
        
        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        
        .player-actions {
            display: flex;
            gap: 5px;
        }
        
        .player-actions button {
            padding: 5px 10px;
            font-size: 0.8rem;
            margin: 0;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .catch-btn {
            background: #ff9800;
        }
        
        @media (max-width: 768px) {
            .game-info {
                flex-direction: column;
            }
            
            .info-card {
                margin: 5px 0;
            }
            
            .host-controls {
                flex-direction: column;
            }
            
            .config-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>现实版躲猫猫</h1>
            <p>基于P2P技术的现实位置躲猫猫游戏</p>
        </header>
        
        <!-- 初始界面 - 创建/加入房间 -->
        <div id="setupPhase" class="game-phase active">
            <div class="form-container">
                <h2>创建或加入游戏</h2>
                <div class="form-group">
                    <label for="playerName">你的昵称</label>
                    <input type="text" id="playerName" placeholder="输入你的昵称">
                </div>
                
                <div class="form-group">
                    <label for="roomAction">选择操作</label>
                    <select id="roomAction">
                        <option value="create">创建房间</option>
                        <option value="join">加入房间</option>
                    </select>
                </div>
                
                <div class="form-group" id="roomIdGroup">
                    <label for="roomId">房间号</label>
                    <input type="text" id="roomId" placeholder="输入房间号">
                </div>
                
                <div class="form-group" id="gameConfig" style="display: none;">
                    <h3>游戏配置</h3>
                    <div class="config-grid">
                        <div>
                            <label for="hideTime">躲藏时间（分钟）</label>
                            <input type="number" id="hideTime" value="5" min="1" max="30">
                        </div>
                        <div>
                            <label for="locationInterval">扫描冷却（分钟）</label>
                            <input type="number" id="locationInterval" value="10" min="5" max="30">
                        </div>
                        <div>
                            <label for="locationDuration">扫描时间（秒）</label>
                            <input type="number" id="locationDuration" value="60" min="10" max="120">
                        </div>
                        <div>
                            <label for="scanCount">扫描次数</label>
                            <input type="number" id="scanCount" value="3" min="1" max="10">
                        </div>
                    </div>
                </div>
                
                <button id="startBtn">开始</button>
            </div>
        </div>
        
        <!-- 房间等待界面 -->
        <div id="lobbyPhase" class="game-phase">
            <div class="form-container">
                <h2>房间: <span id="displayRoomId"></span></h2>
                <p>房主: <span id="hostName"></span></p>
                
                <div class="players-list">
                    <h3>玩家列表</h3>
                    <div id="playersContainer"></div>
                </div>
                
                <div id="hostControls">
                    <div class="host-controls">
                        <button id="randomCatBtn">随机指定猫</button>
                        <button id="startGameBtn" disabled>开始游戏</button>
                    </div>
                </div>
                
                <div id="playerControls">
                    <div class="player-controls">
                        <button id="readyBtn">准备</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 游戏进行界面 -->
        <div id="gamePhase" class="game-phase">
            <div class="game-area">
                <div class="game-info">
                    <div class="info-card">
                        <h3>游戏状态</h3>
                        <p id="gameStateText">等待开始</p>
                    </div>
                    <div class="info-card">
                        <h3>剩余时间</h3>
                        <p id="timer">00:00</p>
                    </div>
                    <div class="info-card">
                        <h3>你的角色</h3>
                        <p id="playerRole">未知</p>
                    </div>
                    <div class="info-card">
                        <h3>扫描次数</h3>
                        <p id="scanCountDisplay">0/0</p>
                    </div>
                </div>
                
                <div id="statusMessage" class="status-message"></div>
                
                <div id="gameMap" style="display: none;"></div>
                
                <div class="controls">
                    <button id="caughtBtn" class="caught-btn">我被抓住了</button>
                    <button id="leaveGameBtn">离开游戏</button>
                </div>
                
                <div class="players-list">
                    <h3>玩家状态</h3>
                    <div id="gamePlayersContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 游戏状态管理
        const GameState = {
            SETUP: 'setup',
            LOBBY: 'lobby',
            HIDING: 'hiding',
            SEEKING: 'seeking',
            ENDED: 'ended'
        };

        // 玩家角色
        const PlayerRole = {
            UNASSIGNED: 'unassigned',
            CAT: 'cat',
            MOUSE: 'mouse'
        };

        // 游戏配置
        let gameConfig = {
            hideTime: 5, // 躲藏时间（分钟）
            locationInterval: 10, // 扫描冷却（分钟）
            locationDuration: 60, // 扫描时间（秒）
            scanCount: 3, // 扫描次数
            scansRemaining: 3 // 剩余扫描次数
        };

        // 游戏状态
        let gameState = GameState.SETUP;
        let currentPlayer = {
            id: '',
            name: '',
            role: PlayerRole.UNASSIGNED,
            isReady: false,
            isHost: false,
            position: null,
            isCaught: false,
            requestingCatch: false // 新增：是否请求被抓
        };
        
        let players = {};
        let peer = null;
        let hostConnection = null;
        let connections = {};
        let gameTimer = null;
        let locationUpdateTimer = null;
        let locationDisplayTimer = null;
        let map = null;
        let markers = {};

        // DOM元素
        const setupPhase = document.getElementById('setupPhase');
        const lobbyPhase = document.getElementById('lobbyPhase');
        const gamePhase = document.getElementById('gamePhase');
        const playerNameInput = document.getElementById('playerName');
        const roomActionSelect = document.getElementById('roomAction');
        const roomIdGroup = document.getElementById('roomIdGroup');
        const gameConfigDiv = document.getElementById('gameConfig');
        const roomIdInput = document.getElementById('roomId');
        const startBtn = document.getElementById('startBtn');
        const displayRoomId = document.getElementById('displayRoomId');
        const hostName = document.getElementById('hostName');
        const playersContainer = document.getElementById('playersContainer');
        const hostControls = document.getElementById('hostControls');
        const playerControls = document.getElementById('playerControls');
        const randomCatBtn = document.getElementById('randomCatBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const readyBtn = document.getElementById('readyBtn');
        const gameStateText = document.getElementById('gameStateText');
        const timerDisplay = document.getElementById('timer');
        const playerRole = document.getElementById('playerRole');
        const scanCountDisplay = document.getElementById('scanCountDisplay');
        const statusMessage = document.getElementById('statusMessage');
        const gameMap = document.getElementById('gameMap');
        const caughtBtn = document.getElementById('caughtBtn');
        const leaveGameBtn = document.getElementById('leaveGameBtn');
        const gamePlayersContainer = document.getElementById('gamePlayersContainer');
        const hideTimeInput = document.getElementById('hideTime');
        const locationIntervalInput = document.getElementById('locationInterval');
        const locationDurationInput = document.getElementById('locationDuration');
        const scanCountInput = document.getElementById('scanCount');

        // 初始化
        function init() {
            // 事件监听
            roomActionSelect.addEventListener('change', toggleRoomAction);
            startBtn.addEventListener('click', handleStart);
            randomCatBtn.addEventListener('click', assignRandomCat);
            startGameBtn.addEventListener('click', startGame);
            readyBtn.addEventListener('click', toggleReady);
            caughtBtn.addEventListener('click', declareCaught);
            leaveGameBtn.addEventListener('click', leaveGame);
            
            // 初始化PeerJS
            peer = new Peer();
            
            peer.on('open', (id) => {
                console.log('My peer ID is: ' + id);
                currentPlayer.id = id;
            });
            
            peer.on('connection', (conn) => {
                console.log('收到连接: ' + conn.peer);
                setupConnection(conn);
            });
            
            peer.on('error', (err) => {
                console.error('PeerJS错误:', err);
                alert('连接错误: ' + err.message);
            });
        }

        // 切换创建/加入房间UI
        function toggleRoomAction() {
            if (roomActionSelect.value === 'create') {
                roomIdGroup.style.display = 'none';
                gameConfigDiv.style.display = 'block';
            } else {
                roomIdGroup.style.display = 'block';
                gameConfigDiv.style.display = 'none';
            }
        }

        // 处理开始按钮点击
        function handleStart() {
            const name = playerNameInput.value.trim();
            if (!name) {
                alert('请输入昵称');
                return;
            }
            
            currentPlayer.name = name;
            
            if (roomActionSelect.value === 'create') {
                createRoom();
            } else {
                const roomId = roomIdInput.value.trim();
                if (!roomId) {
                    alert('请输入房间号');
                    return;
                }
                joinRoom(roomId);
            }
        }

        // 创建房间
        function createRoom() {
            // 保存游戏配置
            gameConfig.hideTime = parseInt(hideTimeInput.value);
            gameConfig.locationInterval = parseInt(locationIntervalInput.value);
            gameConfig.locationDuration = parseInt(locationDurationInput.value);
            gameConfig.scanCount = parseInt(scanCountInput.value);
            gameConfig.scansRemaining = gameConfig.scanCount;
            
            currentPlayer.isHost = true;
            currentPlayer.role = PlayerRole.UNASSIGNED;
            currentPlayer.isReady = true; // 房主默认准备
            
            // 使用自己的peer ID作为房间号
            const roomId = currentPlayer.id;
            displayRoomId.textContent = roomId;
            hostName.textContent = currentPlayer.name;
            
            // 添加自己到玩家列表
            players[currentPlayer.id] = {...currentPlayer};
            
            // 切换到大厅界面
            switchPhase(GameState.LOBBY);
            updatePlayersList();
            
            // 显示房主控制按钮
            hostControls.style.display = 'block';
            playerControls.style.display = 'none';
        }

        // 加入房间
        function joinRoom(roomId) {
            currentPlayer.isHost = false;
            
            // 连接到房主
            hostConnection = peer.connect(roomId);
            setupConnection(hostConnection);
            
            displayRoomId.textContent = roomId;
            hostName.textContent = '连接中...';
            
            // 切换到大厅界面
            switchPhase(GameState.LOBBY);
            
            // 显示玩家控制按钮
            hostControls.style.display = 'none';
            playerControls.style.display = 'block';
        }

        // 设置连接
        function setupConnection(conn) {
            conn.on('open', () => {
                console.log('连接已建立: ' + conn.peer);
                connections[conn.peer] = conn;
                
                // 如果是房主，保存连接
                if (currentPlayer.isHost) {
                    // 发送当前游戏状态给新玩家
                    sendToPlayer(conn, {
                        type: 'gameState',
                        state: gameState,
                        players: players,
                        config: gameConfig
                    });
                } else if (conn.peer === displayRoomId.textContent) {
                    // 如果是玩家，保存房主连接
                    hostConnection = conn;
                    // 发送加入请求
                    sendToHost({
                        type: 'playerJoin',
                        player: currentPlayer
                    });
                }
            });
            
            conn.on('data', (data) => {
                handleMessage(data, conn);
            });
            
            conn.on('close', () => {
                console.log('连接关闭: ' + conn.peer);
                delete connections[conn.peer];
                
                if (currentPlayer.isHost) {
                    // 从玩家列表中移除
                    delete players[conn.peer];
                    updatePlayersList();
                } else if (conn.peer === displayRoomId.textContent) {
                    // 房主断开连接
                    alert('房主已断开连接，游戏结束');
                    resetGame();
                }
            });
            
            conn.on('error', (err) => {
                console.error('连接错误:', err);
            });
        }

        // 处理收到的消息
        function handleMessage(data, conn) {
            console.log('收到消息:', data);
            
            switch (data.type) {
                case 'gameState':
                    // 更新游戏状态
                    gameState = data.state;
                    players = data.players;
                    gameConfig = data.config;
                    
                    if (gameState === GameState.LOBBY) {
                        switchPhase(GameState.LOBBY);
                        updatePlayersList();
                    } else if (gameState === GameState.HIDING || gameState === GameState.SEEKING) {
                        switchPhase(GameState.HIDING);
                        startGameFromData(data);
                    }
                    break;
                    
                case 'playerJoin':
                    if (currentPlayer.isHost) {
                        // 添加新玩家
                        players[data.player.id] = {
                            ...data.player,
                            role: PlayerRole.UNASSIGNED,
                            isReady: false,
                            position: null,
                            isCaught: false,
                            requestingCatch: false
                        };
                        updatePlayersList();
                        
                        // 广播更新后的玩家列表
                        broadcast({
                            type: 'playersUpdate',
                            players: players
                        });
                    }
                    break;
                    
                case 'playersUpdate':
                    players = data.players;
                    updatePlayersList();
                    break;
                    
                case 'playerReady':
                    if (currentPlayer.isHost) {
                        players[data.playerId].isReady = data.isReady;
                        updatePlayersList();
                        
                        // 检查是否所有玩家都准备
                        checkAllReady();
                        
                        // 广播准备状态更新
                        broadcast({
                            type: 'playersUpdate',
                            players: players
                        });
                    }
                    break;
                    
                case 'assignCat':
                    // 更新猫的分配
                    if (currentPlayer.isHost) {
                        assignCatToPlayer(data.catPlayerId);
                    } else {
                        // 更新自己的角色
                        if (data.catPlayerId === currentPlayer.id) {
                            currentPlayer.role = PlayerRole.CAT;
                            playerRole.textContent = '猫';
                        } else {
                            currentPlayer.role = PlayerRole.MOUSE;
                            playerRole.textContent = '老鼠';
                        }
                        updatePlayersList();
                    }
                    break;
                    
                case 'startGame':
                    startGameFromData(data);
                    break;
                    
                case 'playerPosition':
                    if (currentPlayer.isHost) {
                        // 更新玩家位置
                        players[data.playerId].position = data.position;
                        
                        // 如果是猫，广播位置给所有玩家
                        if (players[data.playerId].role === PlayerRole.CAT) {
                            broadcast({
                                type: 'playerPosition',
                                playerId: data.playerId,
                                position: data.position,
                                role: PlayerRole.CAT
                            });
                        }
                        // 如果是老鼠且游戏处于寻找阶段，根据规则广播位置
                        else if (players[data.playerId].role === PlayerRole.MOUSE && gameState === GameState.SEEKING) {
                            // 这里简化处理，实际应根据时间间隔规则广播
                            broadcast({
                                type: 'playerPosition',
                                playerId: data.playerId,
                                position: data.position,
                                role: PlayerRole.MOUSE
                            });
                        }
                    } else {
                        // 更新其他玩家位置
                        if (players[data.playerId]) {
                            players[data.playerId].position = data.position;
                        }
                        updateGameMap();
                    }
                    break;
                    
                case 'requestCatch':
                    if (currentPlayer.isHost) {
                        handleRequestCatch(data.playerId);
                    } else {
                        // 更新玩家请求被抓状态
                        if (players[data.playerId]) {
                            players[data.playerId].requestingCatch = true;
                        }
                        updateGamePlayersList();
                    }
                    break;
                    
                case 'cancelCatch':
                    if (currentPlayer.isHost) {
                        handleCancelCatch(data.playerId);
                    } else {
                        // 更新玩家请求被抓状态
                        if (players[data.playerId]) {
                            players[data.playerId].requestingCatch = false;
                        }
                        updateGamePlayersList();
                    }
                    break;
                    
                case 'playerCaught':
                    if (currentPlayer.isHost) {
                        handlePlayerCaught(data.playerId, data.catPlayerId);
                    } else {
                        // 更新玩家被抓状态
                        if (players[data.playerId]) {
                            players[data.playerId].isCaught = true;
                            players[data.playerId].role = PlayerRole.CAT;
                            players[data.playerId].requestingCatch = false;
                        }
                        updateGamePlayersList();
                        
                        // 如果自己被抓，更新角色
                        if (data.playerId === currentPlayer.id) {
                            currentPlayer.role = PlayerRole.CAT;
                            currentPlayer.isCaught = true;
                            currentPlayer.requestingCatch = false;
                            playerRole.textContent = '猫';
                            statusMessage.textContent = '你已被抓住，现在你也是猫了！';
                            statusMessage.className = 'status-message status-seeking';
                            
                            // 如果是猫，显示地图
                            if (currentPlayer.role === PlayerRole.CAT) {
                                gameMap.style.display = 'block';
                                initMap();
                            }
                        }
                    }
                    break;
                    
                case 'scanUpdate':
                    gameConfig.scansRemaining = data.scansRemaining;
                    updateScanCountDisplay();
                    break;
                    
                case 'gameOver':
                    alert('游戏结束！' + data.message);
                    resetGame();
                    break;

                case 'backToLobby':
                    // 收到返回大厅的消息
                    switchPhase(GameState.LOBBY);
                    resetGameState();
                    break;
            }
        }

        // 发送消息给房主
        function sendToHost(message) {
            if (hostConnection) {
                hostConnection.send(message);
            }
        }

        // 发送消息给特定玩家
        function sendToPlayer(conn, message) {
            conn.send(message);
        }

        // 广播消息给所有玩家
        function broadcast(message) {
            for (const connId in connections) {
                connections[connId].send(message);
            }
        }

        // 切换游戏阶段
        function switchPhase(phase) {
            // 隐藏所有阶段
            setupPhase.classList.remove('active');
            lobbyPhase.classList.remove('active');
            gamePhase.classList.remove('active');
            
            // 显示当前阶段
            switch (phase) {
                case GameState.SETUP:
                    setupPhase.classList.add('active');
                    break;
                case GameState.LOBBY:
                    lobbyPhase.classList.add('active');
                    break;
                case GameState.HIDING:
                case GameState.SEEKING:
                    gamePhase.classList.add('active');
                    // 初始化地图（只有猫显示地图）
                    if (phase === GameState.HIDING && currentPlayer.role === PlayerRole.CAT) {
                        gameMap.style.display = 'block';
                        initMap();
                    } else {
                        gameMap.style.display = 'none';
                    }
                    break;
            }
            
            gameState = phase;
        }

        // 初始化高德地图
        function initMap() {
            if (map) {
                map.destroy();
                map = null;
                markers = {};
            }
            
            // 获取当前位置或使用默认位置
            let center = [116.397428, 39.90923]; // 默认北京中心
            if (currentPlayer.position) {
                center = [currentPlayer.position.longitude, currentPlayer.position.latitude];
            }
            
            map = new AMap.Map('gameMap', {
                viewMode: '3D',
                zoom: 15,
                center: center,
                mapStyle: 'amap://styles/normal'
            });
            
            // 添加比例尺
            map.addControl(new AMap.Scale());
            
            // 添加工具栏
            map.addControl(new AMap.ToolBar());
            
            // 更新所有玩家位置
            updateGameMap();
        }

        // 更新玩家列表
        function updatePlayersList() {
            playersContainer.innerHTML = '';
            for (const playerId in players) {
                const player = players[playerId];
                const playerElement = document.createElement('div');
                playerElement.className = `player ${player.isReady ? 'ready' : ''} ${player.role}`;
                
                let playerActions = '';
                if (currentPlayer.isHost) {
                    playerActions = `
                        <div class="player-actions">
                            <button class="assign-cat-btn" data-player-id="${playerId}">指定为猫</button>
                        </div>
                    `;
                }
                
                playerElement.innerHTML = `
                    <span>${player.name} ${player.isHost ? '(房主)' : ''}</span>
                    <div>
                        <span>${player.isReady ? '已准备' : '未准备'} | ${getRoleText(player.role)}</span>
                        ${playerActions}
                    </div>
                `;
                playersContainer.appendChild(playerElement);
            }
            
            // 为指定猫按钮添加事件监听
            document.querySelectorAll('.assign-cat-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const playerId = e.target.getAttribute('data-player-id');
                    assignCatToPlayer(playerId);
                });
            });
            
            // 更新游戏中的玩家列表
            updateGamePlayersList();
            
            // 检查是否所有玩家都准备
            checkAllReady();
        }

        // 更新游戏中的玩家列表
        function updateGamePlayersList() {
            gamePlayersContainer.innerHTML = '';
            for (const playerId in players) {
                const player = players[playerId];
                const playerElement = document.createElement('div');
                let playerActions = '';
                
                // 如果是猫，并且当前玩家也是猫，并且有老鼠请求被抓，显示"抓住了"按钮
                if (currentPlayer.role === PlayerRole.CAT && 
                    player.role === PlayerRole.MOUSE && 
                    !player.isCaught && 
                    player.requestingCatch) {
                    playerActions = `
                        <div class="player-actions">
                            <button class="catch-btn" data-player-id="${playerId}">抓住了</button>
                        </div>
                    `;
                }
                
                playerElement.className = `player ${player.role} ${player.isCaught ? 'caught' : ''} ${player.requestingCatch ? 'requesting-catch' : ''}`;
                playerElement.innerHTML = `
                    <span>${player.name}</span>
                    <div>
                        <span>${getRoleText(player.role)} ${player.isCaught ? '(已抓住)' : ''} ${player.requestingCatch ? '(请求被抓)' : ''}</span>
                        ${playerActions}
                    </div>
                `;
                gamePlayersContainer.appendChild(playerElement);
            }
            
            // 为抓住了按钮添加事件监听
            document.querySelectorAll('.catch-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const playerId = e.target.getAttribute('data-player-id');
                    confirmCatch(playerId);
                });
            });
        }

        // 确认抓住
        function confirmCatch(playerId) {
            if (currentPlayer.role !== PlayerRole.CAT) return;
            
            sendToHost({
                type: 'playerCaught',
                playerId: playerId,
                catPlayerId: currentPlayer.id
            });
        }

        // 获取角色文本
        function getRoleText(role) {
            switch (role) {
                case PlayerRole.CAT:
                    return '猫';
                case PlayerRole.MOUSE:
                    return '老鼠';
                default:
                    return '未分配';
            }
        }

        // 检查所有玩家是否准备
        function checkAllReady() {
            if (!currentPlayer.isHost) return;
            
            let allReady = true;
            let hasCat = false;
            
            for (const playerId in players) {
                if (!players[playerId].isReady) {
                    allReady = false;
                    break;
                }
                if (players[playerId].role === PlayerRole.CAT) {
                    hasCat = true;
                }
            }
            
            startGameBtn.disabled = !(allReady && hasCat);
        }

        // 切换准备状态
        function toggleReady() {
            currentPlayer.isReady = !currentPlayer.isReady;
            readyBtn.textContent = currentPlayer.isReady ? '取消准备' : '准备';
            
            sendToHost({
                type: 'playerReady',
                playerId: currentPlayer.id,
                isReady: currentPlayer.isReady
            });
        }

        // 随机指定猫
        function assignRandomCat() {
            if (!currentPlayer.isHost) return;
            
            // 随机选择一名玩家作为猫
            const playerIds = Object.keys(players);
            const randomIndex = Math.floor(Math.random() * playerIds.length);
            const catPlayerId = playerIds[randomIndex];
            
            assignCatToPlayer(catPlayerId);
        }

        // 分配猫给特定玩家
        function assignCatToPlayer(catPlayerId) {
            if (!currentPlayer.isHost) return;
            
            // 重置所有玩家角色
            for (const playerId in players) {
                players[playerId].role = PlayerRole.MOUSE;
            }
            
            // 设置猫
            players[catPlayerId].role = PlayerRole.CAT;
            
            // 如果是房主自己，也更新当前玩家的角色
            if (catPlayerId === currentPlayer.id) {
                currentPlayer.role = PlayerRole.CAT;
            }
            
            updatePlayersList();
            
            // 广播猫的分配
            broadcast({
                type: 'assignCat',
                catPlayerId: catPlayerId
            });
            
            // 检查是否所有玩家都准备
            checkAllReady();
        }

        // 开始游戏
        function startGame() {
            if (!currentPlayer.isHost) return;
            
            gameState = GameState.HIDING;
            
            // 获取玩家位置
            getPlayerLocation();
            
            // 广播游戏开始
            broadcast({
                type: 'startGame',
                state: gameState,
                players: players,
                config: gameConfig,
                startTime: Date.now()
            });
            
            // 开始游戏计时
            startGameTimer();
            
            // 切换到游戏界面
            switchPhase(GameState.HIDING);
            updateGameInterface();
        }

        // 从数据开始游戏
        function startGameFromData(data) {
            gameState = data.state;
            players = data.players;
            gameConfig = data.config;
            
            // 更新自己的角色
            if (players[currentPlayer.id]) {
                currentPlayer.role = players[currentPlayer.id].role;
                currentPlayer.isCaught = players[currentPlayer.id].isCaught;
                currentPlayer.requestingCatch = players[currentPlayer.id].requestingCatch;
            }
            
            // 更新角色显示
            playerRole.textContent = getRoleText(currentPlayer.role);
            
            // 获取玩家位置
            getPlayerLocation();
            
            // 开始游戏计时
            startGameTimer();
            
            // 切换到游戏界面
            switchPhase(GameState.HIDING);
            updateGameInterface();
        }

        // 开始游戏计时器
        function startGameTimer() {
            clearInterval(gameTimer);
            
            const startTime = Date.now();
            const hideTimeMs = gameConfig.hideTime * 60 * 1000;
            
            gameTimer = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const remaining = hideTimeMs - elapsed;
                
                if (remaining <= 0) {
                    // 躲藏时间结束，切换到寻找阶段
                    gameState = GameState.SEEKING;
                    updateGameInterface();
                    
                    // 开始位置更新计时器
                    startLocationUpdateTimer();
                    
                    clearInterval(gameTimer);
                    timerDisplay.textContent = '00:00';
                } else {
                    const minutes = Math.floor(remaining / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        // 开始位置更新计时器
        function startLocationUpdateTimer() {
            clearInterval(locationUpdateTimer);
            
            locationUpdateTimer = setInterval(() => {
                // 更新自己的位置
                getPlayerLocation();
                
                // 如果还有扫描次数，广播老鼠位置给所有玩家
                if (currentPlayer.isHost && gameConfig.scansRemaining > 0) {
                    broadcastMousePositions();
                    
                    // 减少扫描次数
                    gameConfig.scansRemaining--;
                    updateScanCountDisplay();
                    
                    // 广播扫描次数更新
                    broadcast({
                        type: 'scanUpdate',
                        scansRemaining: gameConfig.scansRemaining
                    });
                    
                    // 设置定时器停止显示老鼠位置
                    clearTimeout(locationDisplayTimer);
                    locationDisplayTimer = setTimeout(() => {
                        // 停止显示老鼠位置
                        // 在实际实现中，这里应该清除老鼠的位置显示
                    }, gameConfig.locationDuration * 1000);
                }
                
                // 如果没有扫描次数了，停止计时器
                if (gameConfig.scansRemaining <= 0) {
                    clearInterval(locationUpdateTimer);
                }
            }, gameConfig.locationInterval * 60 * 1000);
        }

        // 更新扫描次数显示
        function updateScanCountDisplay() {
            scanCountDisplay.textContent = `${gameConfig.scansRemaining}/${gameConfig.scanCount}`;
        }

        // 广播老鼠位置
        function broadcastMousePositions() {
            if (!currentPlayer.isHost) return;
            
            for (const playerId in players) {
                if (players[playerId].role === PlayerRole.MOUSE && !players[playerId].isCaught && players[playerId].position) {
                    broadcast({
                        type: 'playerPosition',
                        playerId: playerId,
                        position: players[playerId].position,
                        role: PlayerRole.MOUSE
                    });
                }
            }
        }

        // 更新游戏界面
        function updateGameInterface() {
            // 更新游戏状态文本
            if (gameState === GameState.HIDING) {
                gameStateText.textContent = '躲藏阶段';
                statusMessage.textContent = '尽快找到躲藏的地方！';
                statusMessage.className = 'status-message status-hiding';
                
                // 如果是猫，显示提示
                if (currentPlayer.role === PlayerRole.CAT) {
                    statusMessage.textContent = '你是猫，等待躲藏时间结束后开始寻找老鼠！';
                }
            } else if (gameState === GameState.SEEKING) {
                gameStateText.textContent = '寻找阶段';
                statusMessage.textContent = '猫正在寻找老鼠！';
                statusMessage.className = 'status-message status-seeking';
                
                // 根据角色显示不同提示
                if (currentPlayer.role === PlayerRole.CAT) {
                    statusMessage.textContent = '你是猫，快去抓住老鼠！';
                } else if (currentPlayer.role === PlayerRole.MOUSE) {
                    statusMessage.textContent = '你是老鼠，小心不要被猫抓住！';
                }
            }
            
            // 更新角色显示
            playerRole.textContent = getRoleText(currentPlayer.role);
            
            // 更新扫描次数显示
            updateScanCountDisplay();
            
            // 更新玩家列表
            updateGamePlayersList();
            
            // 更新地图（只有猫显示地图）
            if (currentPlayer.role === PlayerRole.CAT) {
                gameMap.style.display = 'block';
                updateGameMap();
            } else {
                gameMap.style.display = 'none';
            }
            
            // 根据角色显示/隐藏被抓按钮
            if (currentPlayer.role === PlayerRole.MOUSE && !currentPlayer.isCaught) {
                caughtBtn.style.display = 'block';
                if (currentPlayer.requestingCatch) {
                    caughtBtn.textContent = '取消被抓请求';
                    caughtBtn.style.background = '#ff9800';
                } else {
                    caughtBtn.textContent = '我被抓住了';
                    caughtBtn.style.background = '#f44336';
                }
            } else {
                caughtBtn.style.display = 'none';
            }
        }

        // 更新游戏地图
        function updateGameMap() {
            if (!map) return;
            
            // 清除所有标记
            for (const playerId in markers) {
                map.remove(markers[playerId]);
            }
            markers = {};
            
            // 添加玩家位置标记
            for (const playerId in players) {
                const player = players[playerId];
                if (player.position) {
                    const position = [player.position.longitude, player.position.latitude];
                    
                    // 根据角色设置标记颜色和内容
                    let markerContent = '';
                    let markerColor = '';
                    
                    if (player.role === PlayerRole.CAT) {
                        markerColor = '#f44336'; // 红色表示猫
                        markerContent = `<div style="background-color: ${markerColor}; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">猫</div>`;
                    } else {
                        markerColor = '#4CAF50'; // 绿色表示老鼠
                        markerContent = `<div style="background-color: ${markerColor}; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">鼠</div>`;
                    }
                    
                    // 创建标记
                    const marker = new AMap.Marker({
                        position: position,
                        content: markerContent,
                        offset: new AMap.Pixel(-10, -10)
                    });
                    
                    // 添加标记到地图
                    map.add(marker);
                    markers[playerId] = marker;
                    
                    // 添加信息窗口
                    const infoWindow = new AMap.InfoWindow({
                        content: `<div>${player.name} (${getRoleText(player.role)})</div>`,
                        offset: new AMap.Pixel(0, -30)
                    });
                    
                    marker.on('click', () => {
                        infoWindow.open(map, marker.getPosition());
                    });
                }
            }
            
            // 如果当前玩家有位置，将地图中心设置为当前位置
            if (currentPlayer.position) {
                map.setCenter([currentPlayer.position.longitude, currentPlayer.position.latitude]);
            }
        }

        // 获取玩家位置
        function getPlayerLocation() {
            if (!navigator.geolocation) {
                alert('你的浏览器不支持地理定位');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const newPosition = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    currentPlayer.position = newPosition;
                    
                    // 发送位置给房主
                    if (!currentPlayer.isHost) {
                        sendToHost({
                            type: 'playerPosition',
                            playerId: currentPlayer.id,
                            position: newPosition
                        });
                    } else {
                        // 房主更新自己的位置
                        players[currentPlayer.id].position = newPosition;
                        
                        // 如果是猫，广播位置
                        if (currentPlayer.role === PlayerRole.CAT) {
                            broadcast({
                                type: 'playerPosition',
                                playerId: currentPlayer.id,
                                position: newPosition,
                                role: PlayerRole.CAT
                            });
                        }
                    }
                    
                    // 更新地图
                    updateGameMap();
                },
                (error) => {
                    console.error('获取位置失败:', error);
                    alert('无法获取你的位置，请确保已启用位置服务');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        // 声明被抓
        function declareCaught() {
            if (currentPlayer.role !== PlayerRole.MOUSE || currentPlayer.isCaught) return;
            
            if (currentPlayer.requestingCatch) {
                // 取消被抓请求
                currentPlayer.requestingCatch = false;
                sendToHost({
                    type: 'cancelCatch',
                    playerId: currentPlayer.id
                });
            } else {
                // 请求被抓
                currentPlayer.requestingCatch = true;
                sendToHost({
                    type: 'requestCatch',
                    playerId: currentPlayer.id
                });
            }
            
            updateGameInterface();
        }

        // 处理请求被抓
        function handleRequestCatch(playerId) {
            if (!currentPlayer.isHost) return;
            
            players[playerId].requestingCatch = true;
            
            // 广播玩家状态更新
            broadcast({
                type: 'playersUpdate',
                players: players
            });
        }

        // 处理取消被抓请求
        function handleCancelCatch(playerId) {
            if (!currentPlayer.isHost) return;
            
            players[playerId].requestingCatch = false;
            
            // 广播玩家状态更新
            broadcast({
                type: 'playersUpdate',
                players: players
            });
        }

        // 处理玩家被抓
        function handlePlayerCaught(playerId, catPlayerId) {
            if (!currentPlayer.isHost) return;
            
            // 更新玩家状态
            players[playerId].isCaught = true;
            players[playerId].role = PlayerRole.CAT;
            players[playerId].requestingCatch = false;
            
            // 广播被抓消息
            broadcast({
                type: 'playerCaught',
                playerId: playerId,
                catPlayerId: catPlayerId
            });
            
            // 检查游戏是否结束
            checkGameOver();
            
            // 更新玩家列表
            updatePlayersList();
            updateGamePlayersList();
        }

        // 查找猫玩家ID
        function findCatPlayerId() {
            for (const playerId in players) {
                if (players[playerId].role === PlayerRole.CAT && !players[playerId].isCaught) {
                    return playerId;
                }
            }
            return null;
        }

        // 检查游戏是否结束
        function checkGameOver() {
            if (!currentPlayer.isHost) return;
            
            let miceCount = 0;
            for (const playerId in players) {
                if (players[playerId].role === PlayerRole.MOUSE && !players[playerId].isCaught) {
                    miceCount++;
                }
            }
            
            if (miceCount === 0) {
                // 所有老鼠都被抓住，游戏结束
                broadcast({
                    type: 'gameOver',
                    message: '所有老鼠都被抓住了，猫获胜！'
                });
                
                alert('游戏结束！所有老鼠都被抓住了，猫获胜！');
                resetGame();
            }
        }

        // 离开游戏
        function leaveGame() {
            if (confirm('确定要离开游戏吗？')) {
                if (currentPlayer.isHost) {
                    // 房主离开游戏，通知所有玩家返回大厅
                    broadcast({
                        type: 'backToLobby'
                    });
                    // 房主自己也返回大厅
                    switchPhase(GameState.LOBBY);
                    resetGameState();
                } else {
                    // 普通玩家离开游戏，返回大厅
                    switchPhase(GameState.LOBBY);
                    resetGameState();
                }
            }
        }

        // 重置游戏状态（但不重置房间）
        function resetGameState() {
            // 清除计时器
            clearInterval(gameTimer);
            clearInterval(locationUpdateTimer);
            clearTimeout(locationDisplayTimer);
            
            // 销毁地图
            if (map) {
                map.destroy();
                map = null;
                markers = {};
            }
            
            // 重置游戏状态（但不重置房间和玩家连接）
            gameState = GameState.LOBBY;
            
            // 重置当前玩家的游戏状态
            currentPlayer.role = PlayerRole.UNASSIGNED;
            currentPlayer.position = null;
            currentPlayer.isCaught = false;
            currentPlayer.requestingCatch = false;
            
            // 房主保持准备状态，普通玩家重置准备状态
            if (currentPlayer.isHost) {
                currentPlayer.isReady = true;
            } else {
                currentPlayer.isReady = false;
            }
            
            // 重置所有玩家的游戏状态
            for (const playerId in players) {
                players[playerId].role = PlayerRole.UNASSIGNED;
                players[playerId].position = null;
                players[playerId].isCaught = false;
                players[playerId].requestingCatch = false;
                
                // 房主保持准备状态，普通玩家重置准备状态
                if (players[playerId].isHost) {
                    players[playerId].isReady = true;
                } else {
                    players[playerId].isReady = false;
                }
            }
            
            // 重置游戏配置
            gameConfig.scansRemaining = gameConfig.scanCount;
            
            // 更新玩家列表
            updatePlayersList();
            
            // 更新准备按钮显示
            if (currentPlayer.isHost) {
                readyBtn.textContent = '已准备';
            } else {
                readyBtn.textContent = '准备';
            }
        }

        // 完全重置游戏
        function resetGame() {
            // 清除计时器
            clearInterval(gameTimer);
            clearInterval(locationUpdateTimer);
            clearTimeout(locationDisplayTimer);
            
            // 关闭所有连接
            for (const connId in connections) {
                connections[connId].close();
            }
            
            // 销毁地图
            if (map) {
                map.destroy();
                map = null;
                markers = {};
            }
            
            // 重置游戏状态
            gameState = GameState.SETUP;
            players = {};
            connections = {};
            hostConnection = null;
            
            // 重置当前玩家
            currentPlayer = {
                id: currentPlayer.id,
                name: currentPlayer.name,
                role: PlayerRole.UNASSIGNED,
                isReady: false,
                isHost: false,
                position: null,
                isCaught: false,
                requestingCatch: false
            };
            
            // 切换到初始界面
            switchPhase(GameState.SETUP);
        }

        // 初始化应用
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>